<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<title>Notes</title>
</head>
<body>

<header>
  <span>Notes</span>
  <div>
    <button onclick="toggleTheme()">ðŸŒ™</button>
    <button onclick="panic()">ðŸš¨</button>
  </div>
</header>

<div id="chat"></div>

<footer>
  <button onclick="record()">ðŸŽ¤</button>
  <input id="msg" placeholder="Type message">
  <button onclick="send()">âž¤</button>
</footer>

<script>
const socket = io();
const me = "{{ username }}";
const chat = document.getElementById("chat");
let recorder, chunks = [];

socket.on("receive_message", data => {
  const div = document.createElement("div");
  div.classList.add("msg");
  div.classList.add(data.user === me ? "me" : "other");

  if (data.type === "text") {
    div.innerHTML = data.content.replace(
      /(https?:\/\/\S+)/g,
      '<a href="$1" target="_blank">$1</a>'
    );
  }

  if (data.type === "audio") {
    div.innerHTML = `<audio controls src="${data.content}"></audio>`;
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
});

function send() {
  const i = msg.value.trim();
  if (!i) return;
  socket.emit("send_message", {type:"text", content:i});
  msg.value = "";
}

function record() {
  if (recorder && recorder.state === "recording") {
    recorder.stop();
    return;
  }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
    recorder = new MediaRecorder(stream);
    recorder.start();
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, {type:"audio/webm"});
      chunks = [];
      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("send_message", {
          type:"audio",
          content: reader.result
        });
      };
      reader.readAsDataURL(blob);
    };
  });
}

function toggleTheme() {
  document.body.classList.toggle("light");
}

function panic() {
  socket.disconnect();
  chat.innerHTML = "";
  location.reload();
}
</script>
</body>
</html>

