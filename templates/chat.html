<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Notes</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body>

<header>
  <span>Notes</span>
 <div class="header-actions">
  <button onclick="location.href='/inbox'">ðŸ“¥</button>
  <button onclick="toggleTheme()">ðŸŒ™</button>
  <button class="panic" onclick="panic()">ðŸš¨</button>
</div>
</header>

<div id="chat"></div>

<footer>
  <button onclick="pickImage()">ðŸ“Ž</button>
  <button id="micBtn">ðŸŽ¤</button>
  <input id="msg" placeholder="Type a message">
  <button onclick="sendText()">âž¤</button>
</footer>

<input type="file" id="imageInput" accept="image/*" hidden>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const socket = io();
  const me = "{{ username }}";

  const chat = document.getElementById("chat");
  const msgInput = document.getElementById("msg");
  const imageInput = document.getElementById("imageInput");
  const micBtn = document.getElementById("micBtn");

  let recorder = null;
  let chunks = [];
  let stream = null;

  /* ================= RECEIVE ================= */
  socket.on("receive_message", data => {
    const div = document.createElement("div");
    div.className = "msg " + (data.user === me ? "me" : "other");

    if (data.type === "text") {
      div.innerHTML = data.content.replace(
        /(https?:\/\/\S+)/g,
        '<a href="$1" target="_blank">$1</a>'
      );
    }

    if (data.type === "image") {
      div.innerHTML = `<img src="${data.content}" class="chat-img">`;
    }

    if (data.type === "audio") {
      div.classList.add("audio-msg");

      const audio = document.createElement("audio");
      audio.controls = true;
      audio.preload = "metadata";
      audio.src = data.content;

      audio.addEventListener("loadedmetadata", () => {
        audio.currentTime = 0;
      });

      div.appendChild(audio);
    }

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  });

  /* ================= SEND TEXT ================= */
  window.sendText = () => {
    const text = msgInput.value.trim();
    if (!text) return;
    socket.emit("send_message", { type: "text", content: text });
    msgInput.value = "";
  };

  /* ================= IMAGE ================= */
  window.pickImage = () => imageInput.click();

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      socket.emit("send_message", {
        type: "image",
        content: reader.result
      });
    };
    reader.readAsDataURL(file);
  });

  /* ================= ðŸŽ¤ MIC (MOBILE SAFE HOLD) ================= */

  const stopRecording = () => {
    if (!recorder || recorder.state !== "recording") return;

    recorder.stop();
    micBtn.classList.remove("recording");

    recorder.onstop = () => {
      stream.getTracks().forEach(t => t.stop());

      if (!chunks.length) return;

      const blob = new Blob(chunks, { type: "audio/webm" });
      if (blob.size < 1500) return;

      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("send_message", {
          type: "audio",
          content: reader.result
        });
      };
      reader.readAsDataURL(blob);
    };
  };

  micBtn.addEventListener("touchstart", async (e) => {
    e.preventDefault();
    chunks = [];

    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch {
      alert("Microphone permission denied");
      return;
    }

    recorder = new MediaRecorder(stream, {
      mimeType: "audio/webm;codecs=opus"
    });

    recorder.ondataavailable = e => {
      if (e.data.size > 0) chunks.push(e.data);
    };

    recorder.start();
    micBtn.classList.add("recording");
  });

  micBtn.addEventListener("touchend", (e) => {
    e.preventDefault();
    stopRecording();
  });

  micBtn.addEventListener("touchcancel", stopRecording);

  /* ================= UI ================= */
  window.toggleTheme = () => {
    document.body.classList.toggle("light");
  };

  window.panic = () => {
  // send panic notification to other user
  socket.emit("send_message", {
    type: "text",
    content: "âš ï¸ WARNING -- Panic button Initiated. Chat closed."
  });

  // small delay to ensure message is sent
  setTimeout(() => {
    socket.disconnect();
    chat.innerHTML = "";
    location.reload();
  }, 150);
};


});
</script>

</body>
</html>


