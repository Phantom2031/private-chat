<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Notes</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body>

<header>
  <span>Notes</span>
  <div class="header-actions">
    <button onclick="toggleTheme()">ðŸŒ™</button>
    <button class="panic" onclick="panic()">ðŸš¨</button>
  </div>
</header>

<div id="chat"></div>

<footer>
  <button onclick="pickImage()">ðŸ“Ž</button>
  <button onclick="pickAudio()">ðŸŽ§</button>
  <input id="msg" placeholder="Type a message">
  <button onclick="sendText()">âž¤</button>
</footer>

<input type="file" id="imageInput" accept="image/*" hidden>
<input type="file" id="audioInput" accept="audio/*" hidden>

<script>
const socket = io();
const me = "{{ username }}";
const chat = document.getElementById("chat");

const imageInput = document.getElementById("imageInput");
const audioInput = document.getElementById("audioInput");

// receive messages
socket.on("receive_message", data => {
  const div = document.createElement("div");
  div.className = "msg " + (data.user === me ? "me" : "other");

  if (data.type === "text") {
    div.innerHTML = data.content.replace(
      /(https?:\/\/\S+)/g,
      '<a href="$1" target="_blank">$1</a>'
    );
  }

  if (data.type === "image") {
    div.innerHTML = `<img src="${data.content}" class="chat-img">`;
  }

  if (data.type === "audio") {
    div.innerHTML = `<audio controls src="${data.content}"></audio>`;
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
});

// send text
function sendText() {
  const text = msg.value.trim();
  if (!text) return;
  socket.emit("send_message", { type: "text", content: text });
  msg.value = "";
}

// image
function pickImage() {
  imageInput.click();
}

imageInput.onchange = () => {
  const file = imageInput.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = () => {
    socket.emit("send_message", { type: "image", content: r.result });
  };
  r.readAsDataURL(file);
};

// audio (file based â€“ stable)
function pickAudio() {
  audioInput.click();
}

audioInput.onchange = () => {
  const file = audioInput.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = () => {
    socket.emit("send_message", { type: "audio", content: r.result });
  };
  r.readAsDataURL(file);
};

function toggleTheme() {
  document.body.classList.toggle("light");
}

function panic() {
  socket.disconnect();
  chat.innerHTML = "";
  location.reload();
}
</script>

</body>
</html>
